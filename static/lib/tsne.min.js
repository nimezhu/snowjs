var tsnejs=tsnejs||{REVISION:'ALPHA'};(function(global){"use strict";var assert=function(condition,message){if(!condition){throw message||"Assertion failed";}}
var getopt=function(opt,field,defaultval){if(opt.hasOwnProperty(field)){return opt[field];}else{return defaultval;}}
var return_v=false;var v_val=0.0;var gaussRandom=function(){if(return_v){return_v=false;return v_val;}
var u=2*Math.random()-1;var v=2*Math.random()-1;var r=u*u+v*v;if(r==0||r>1)return gaussRandom();var c=Math.sqrt(-2*Math.log(r)/r);v_val=v*c;return_v=true;return u*c;}
var randn=function(mu,std){return mu+gaussRandom()*std;}
var zeros=function(n){if(typeof(n)==='undefined'||isNaN(n)){return[];}
if(typeof ArrayBuffer==='undefined'){var arr=new Array(n);for(var i=0;i<n;i++){arr[i]=0;}
return arr;}else{return new Float64Array(n);}}
var randn2d=function(n,d,s){var uses=typeof s!=='undefined';var x=[];for(var i=0;i<n;i++){var xhere=[];for(var j=0;j<d;j++){if(uses){xhere.push(s);}else{xhere.push(randn(0.0,1e-4));}}
x.push(xhere);}
return x;}
var L2=function(x1,x2){var D=x1.length;var d=0;for(var i=0;i<D;i++){var x1i=x1[i];var x2i=x2[i];d+=(x1i-x2i)*(x1i-x2i);}
return d;}
var xtod=function(X){var N=X.length;var dist=zeros(N*N);for(var i=0;i<N;i++){for(var j=i+1;j<N;j++){var d=L2(X[i],X[j]);dist[i*N+j]=d;dist[j*N+i]=d;}}
return dist;}
var d2p=function(D,perplexity,tol){var Nf=Math.sqrt(D.length);var N=Math.floor(Nf);assert(N===Nf,"D should have square number of elements.");var Htarget=Math.log(perplexity);var P=zeros(N*N);var prow=zeros(N);for(var i=0;i<N;i++){var betamin=-Infinity;var betamax=Infinity;var beta=1;var done=false;var maxtries=50;var num=0;while(!done){var psum=0.0;for(var j=0;j<N;j++){var pj=Math.exp(-D[i*N+j]*beta);if(i===j){pj=0;}
prow[j]=pj;psum+=pj;}
var Hhere=0.0;for(var j=0;j<N;j++){if(psum==0){var pj=0;}else{var pj=prow[j]/psum;}
prow[j]=pj;if(pj>1e-7)Hhere-=pj*Math.log(pj);}
if(Hhere>Htarget){betamin=beta;if(betamax===Infinity){beta=beta*2;}
else{beta=(beta+betamax)/2;}}else{betamax=beta;if(betamin===-Infinity){beta=beta/2;}
else{beta=(beta+betamin)/2;}}
num++;if(Math.abs(Hhere-Htarget)<tol){done=true;}
if(num>=maxtries){done=true;}}
for(var j=0;j<N;j++){P[i*N+j]=prow[j];}}
var Pout=zeros(N*N);var N2=N*2;for(var i=0;i<N;i++){for(var j=0;j<N;j++){Pout[i*N+j]=Math.max((P[i*N+j]+P[j*N+i])/N2,1e-100);}}
return Pout;}
function sign(x){return x>0?1:x<0?-1:0;}
var tSNE=function(opt){var opt=opt||{};this.perplexity=getopt(opt,"perplexity",30);this.dim=getopt(opt,"dim",2);this.epsilon=getopt(opt,"epsilon",10);this.iter=0;}
tSNE.prototype={initDataRaw:function(X){var N=X.length;var D=X[0].length;assert(N>0," X is empty? You must have some data!");assert(D>0," X[0] is empty? Where is the data?");var dists=xtod(X);this.P=d2p(dists,this.perplexity,1e-4);this.N=N;this.initSolution();},initDataDist:function(D){var N=D.length;assert(N>0," X is empty? You must have some data!");var dists=zeros(N*N);for(var i=0;i<N;i++){for(var j=i+1;j<N;j++){var d=D[i][j];dists[i*N+j]=d;dists[j*N+i]=d;}}
this.P=d2p(dists,this.perplexity,1e-4);this.N=N;this.initSolution();},initSolution:function(){this.Y=randn2d(this.N,this.dim);this.gains=randn2d(this.N,this.dim,1.0);this.ystep=randn2d(this.N,this.dim,0.0);this.iter=0;},getSolution:function(){return this.Y;},step:function(){this.iter+=1;var N=this.N;var cg=this.costGrad(this.Y);var cost=cg.cost;var grad=cg.grad;var ymean=zeros(this.dim);for(var i=0;i<N;i++){for(var d=0;d<this.dim;d++){var gid=grad[i][d];var sid=this.ystep[i][d];var gainid=this.gains[i][d];var newgain=sign(gid)===sign(sid)?gainid*0.8:gainid+0.2;if(newgain<0.01)newgain=0.01;this.gains[i][d]=newgain;var momval=this.iter<250?0.5:0.8;var newsid=momval*sid-this.epsilon*newgain*grad[i][d];this.ystep[i][d]=newsid;this.Y[i][d]+=newsid;ymean[d]+=this.Y[i][d];}}
for(var i=0;i<N;i++){for(var d=0;d<this.dim;d++){this.Y[i][d]-=ymean[d]/N;}}
return cost;},debugGrad:function(){var N=this.N;var cg=this.costGrad(this.Y);var cost=cg.cost;var grad=cg.grad;var e=1e-5;for(var i=0;i<N;i++){for(var d=0;d<this.dim;d++){var yold=this.Y[i][d];this.Y[i][d]=yold+e;var cg0=this.costGrad(this.Y);this.Y[i][d]=yold-e;var cg1=this.costGrad(this.Y);var analytic=grad[i][d];var numerical=(cg0.cost-cg1.cost)/(2*e);console.log(i+','+d+': gradcheck analytic: '+analytic+' vs. numerical: '+numerical);this.Y[i][d]=yold;}}},costGrad:function(Y){var N=this.N;var dim=this.dim;var P=this.P;var pmul=this.iter<100?4:1;var Qu=zeros(N*N);var qsum=0.0;for(var i=0;i<N;i++){for(var j=i+1;j<N;j++){var dsum=0.0;for(var d=0;d<dim;d++){var dhere=Y[i][d]-Y[j][d];dsum+=dhere*dhere;}
var qu=1.0/(1.0+dsum);Qu[i*N+j]=qu;Qu[j*N+i]=qu;qsum+=2*qu;}}
var NN=N*N;var Q=zeros(NN);for(var q=0;q<NN;q++){Q[q]=Math.max(Qu[q]/qsum,1e-100);}
var cost=0.0;var grad=[];for(var i=0;i<N;i++){var gsum=new Array(dim);for(var d=0;d<dim;d++){gsum[d]=0.0;}
for(var j=0;j<N;j++){cost+=-P[i*N+j]*Math.log(Q[i*N+j]);var premult=4*(pmul*P[i*N+j]-Q[i*N+j])*Qu[i*N+j];for(var d=0;d<dim;d++){gsum[d]+=premult*(Y[i][d]-Y[j][d]);}}
grad.push(gsum);}
return{cost:cost,grad:grad};}}
global.tSNE=tSNE;})(tsnejs);(function(lib){"use strict";if(typeof module==="undefined"||typeof module.exports==="undefined"){window.tsnejs=lib;}else{module.exports=lib;}})(tsnejs);